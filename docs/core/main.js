(()=>{"use strict";var e={509:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionStatus=void 0,function(e){e.active="active",e.closed="closed",e.errored="errored",e.new="new",e.pending="pending"}(n||(t.ConnectionStatus=n={}))},908:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||o(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(509),t),i(n(465),t),i(n(782),t),i(n(600),t),i(n(528),t)},465:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,a){function c(e){try{r(o.next(e))}catch(e){a(e)}}function s(e){try{r(o.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}r((o=o.apply(e,t||[])).next())}))},i=this&&this.__rest||function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(o=Object.getOwnPropertySymbols(e);i<o.length;i++)t.indexOf(o[i])<0&&Object.prototype.propertyIsEnumerable.call(e,o[i])&&(n[o[i]]=e[o[i]])}return n};Object.defineProperty(t,"__esModule",{value:!0}),t.MessagingConnection=void 0;const a=n(509),c=n(528),s=n(624);t.MessagingConnection=class{get rtcConnection(){return this._rtcConnection}get localPeerData(){return this._localPeerData}get peerMode(){return this._peerMode}get status(){return this._status}constructor(e={}){this._rtcConnection=void 0,this.localIceCandidates=[],this.on={},this._status=void 0;const{minification:t}=e,n=i(e,["minification"]);this.configuration=n,this.minification=t,this.reset()}closeConnection(){this._rtcConnection.close()}completeConnection(e){const t=(0,s.deserializePeerData)(e,this.minification);this._rtcConnection.setRemoteDescription(t.session)}joinConnection(e){return o(this,void 0,void 0,(function*(){this._peerMode=c.PeerMode.joiner,this._status=a.ConnectionStatus.pending;const t=(0,s.deserializePeerData)(e,this.minification);yield this._rtcConnection.setRemoteDescription(t.session);for(const e of t.candidates)yield this._rtcConnection.addIceCandidate(e);const n=new Promise(((e,t)=>{this.peerDataResolve=e,this.peerDataReject=t}));return this.session=yield this._rtcConnection.createAnswer(),yield this._rtcConnection.setLocalDescription(this.session),n}))}reset(){this.localIceCandidates=[],this.session=void 0,this.peerDataResolve=void 0,this.peerDataReject=void 0,this._peerMode=void 0,this._localPeerData=void 0,this._status=a.ConnectionStatus.new,this._rtcConnection=new RTCPeerConnection(this.configuration),this._rtcConnection.onicecandidate=e=>{var t,n;e.candidate?(this.localIceCandidates.push(e.candidate),null===(n=(t=this.on).iceCandidate)||void 0===n||n.call(t,e.candidate)):this._peerMode===c.PeerMode.starter||this._peerMode===c.PeerMode.joiner&&"complete"===this._rtcConnection.iceGatheringState&&"connected"===this._rtcConnection.iceConnectionState?(this._localPeerData=(0,s.serializePeerData)({candidates:this.localIceCandidates,session:this.session},this.minification),this.peerDataResolve(this._localPeerData)):(this.peerDataReject(new Error("Error during ICE gathering. Use chrome://webrtc-internals to troubleshoot the problem")),this._status=a.ConnectionStatus.errored)},this._rtcConnection.onconnectionstatechange=e=>{var t,n,o;"disconnected"===this._rtcConnection.connectionState&&"disconnected"===this._rtcConnection.iceConnectionState&&this.dataChannel&&(this._status=a.ConnectionStatus.closed,null===(n=(t=this.on).connectionClosed)||void 0===n||n.call(t,this)),null===(o=this.on.connectionStateChange)||void 0===o||o.bind(this._rtcConnection)(e)},this._rtcConnection.ondatachannel=e=>{var t;const n=e.channel;this.setDataChannelHandlers(n),null===(t=this.on.dataChannel)||void 0===t||t.bind(this._rtcConnection)(e)}}sendMessage(e){return!!this.dataChannel&&(this.dataChannel.send(JSON.stringify(e)),!0)}startConnection(){return o(this,void 0,void 0,(function*(){this._peerMode=c.PeerMode.starter,this._status=a.ConnectionStatus.pending;const e=this._rtcConnection.createDataChannel("data-channel");this.setDataChannelHandlers(e);const t=new Promise(((e,t)=>{this.peerDataResolve=e,this.peerDataReject=t}));return this.session=yield this._rtcConnection.createOffer(),yield this._rtcConnection.setLocalDescription(this.session),t}))}setDataChannelHandlers(e){e.onopen=()=>{var t,n;this.dataChannel=e,this._status=a.ConnectionStatus.active,null===(n=(t=this.on).connectionReady)||void 0===n||n.call(t,this)},e.onmessage=e=>{var t,n;const o=JSON.parse(e.data);null===(n=(t=this.on).messageReceived)||void 0===n||n.call(t,o,this)},e.onclose=()=>{var e,t;this.dataChannel=void 0,this._status=a.ConnectionStatus.closed,null===(t=(e=this.on).connectionClosed)||void 0===t||t.call(e,this)}}}},782:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MessagingGroup=void 0;const o=n(509),i=n(465);class a{static from(e,t){const n=new a;return n._nodes=e.nodes.map(((e,n,o)=>({connection:e.connection,state:t(e.state,n,o)}))),n}get activeNodes(){return this._nodes.filter((e=>e.connection.status===o.ConnectionStatus.active))}get nodes(){return this._nodes}constructor(e){this.options=e,this._nodes=[]}addNode(...[e]){this._nodes.push({connection:new i.MessagingConnection(this.options),state:null!=e?e:{}})}broadcastMessage(e){this.activeNodes.forEach((t=>{const n="function"==typeof e?e(t.state):e;t.connection.sendMessage(n)}))}closeAllConnections(){this.activeNodes.forEach((e=>{e.connection.closeConnection()}))}removeNode(e){const t="number"==typeof e?e:this._nodes.findIndex((t=>t.connection===e)),[n]=this._nodes.splice(t,1);(null==n?void 0:n.connection.status)===o.ConnectionStatus.active&&n.connection.closeConnection()}}t.MessagingGroup=a},600:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},528:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.PeerMode=void 0,function(e){e.joiner="joiner",e.starter="starter"}(n||(t.PeerMode=n={}))},624:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.serializePeerData=t.deserializePeerData=void 0;const n=[["\\r\\na=extmap-allow-mixed","_a"],["\\r\\na=fingerprint","_b"],["\\r\\na=ice-options","_c"],["\\r\\na=max-message-size","_d"],["\\r\\na=msid-semantic","_e"],["\\r\\na=sctp-port","_f"],["\\r\\na=setup","_g"],["\\r\\nm=application","_h"],["\\r\\na=ice-ufrag","_i"],["candidate","_j"],["network-cost","_k"],["network-id","_l"],["sdpMLineIndex","_m"],["typ host generation","_n"],["typ host tcptype active generation","_o"],["usernameFragment","_p"],["webrtc-datachannel","_q"],['"type":"offer"',"_r"],["\\r\\na=group","_s"],["sdpMid","_t"],["\\r\\na=mid","_u"],["UDP/DTLS/SCTP","_v"],["\\r\\na=ice-pwd","_w"],[":actpass","_x"],["ufrag","_y"],["BUNDLE","_z"],["trickle","_A"],["IN IP4","_B"],["sha-256","_C"],[" udp ","_D"],[",","_T"],["=","_U"],["{","_V"],["}","_W"],[":","_X"],['"',"_Y"],["\\","_Z"]];t.deserializePeerData=(e,t)=>{const o=t?n.reduce(((e,[t,n])=>e.replaceAll(n,t)),e):e;return JSON.parse(o)},t.serializePeerData=(e,t)=>{const o=JSON.stringify(e);return t?n.reduce(((e,[t,n])=>e.replaceAll(t,n)),o):o}},784:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,a){function c(e){try{r(o.next(e))}catch(e){a(e)}}function s(e){try{r(o.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}r((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.remoteDataParameterName=void 0;const i=n(908);t.remoteDataParameterName="d";const a=document.getElementById("peer-mode-selection"),c=document.getElementById("start-connection"),s=document.getElementById("joiner-remote-data"),r=document.getElementById("join-connection"),d=document.getElementById("waiting-peer-data"),l=document.getElementById("starter-peer"),u=document.getElementById("starter-local-data"),h=document.getElementById("copy-starter-code"),p=document.getElementById("copy-starter-link"),m=document.getElementById("verification-code"),g=document.getElementById("complete-connection"),y=document.getElementById("joiner-peer"),v=document.getElementById("joiner-local-data"),_=document.getElementById("copy-verification-code"),C=document.getElementById("messaging-area"),f=document.getElementById("current-message"),b=document.getElementById("send-message"),P=document.getElementById("messaging-history"),w=document.getElementById("close-connection"),S=document.getElementById("reset"),I=document.getElementById("connection-error"),D=document.getElementById("error-reset"),E=document.getElementById("toggle-rtc-activity"),M=document.getElementById("rtc-activity"),B=document.getElementById("rtc-activity-log"),j=document.getElementById("connectionState"),k=document.getElementById("iceConnectionState"),x=document.getElementById("iceGatheringState"),O=document.getElementById("signalingState"),A=e=>{const t=document.createElement("p");t.innerText=e,P.append(t)},R=new i.MessagingConnection({minification:!0});function N(){j.textContent=R.rtcConnection.connectionState,k.textContent=R.rtcConnection.iceConnectionState,x.textContent=R.rtcConnection.iceGatheringState,O.textContent=R.rtcConnection.signalingState}R.on.connectionReady=()=>{l.style.display="none",y.style.display="none",C.style.display="block",N()},R.on.messageReceived=e=>{A(`They: ${e}`)},R.on.connectionClosed=()=>{f.setAttribute("disabled","true"),b.setAttribute("disabled","true"),w.setAttribute("disabled","true"),S.removeAttribute("disabled"),N()},c.onclick=()=>o(void 0,void 0,void 0,(function*(){a.style.display="none",d.style.display="block";try{yield R.startConnection(),l.style.display="block",u.value=R.localPeerData}catch(e){I.style.display="block"}d.style.display="none"})),h.onclick=()=>{navigator.clipboard.writeText(R.localPeerData)},p.onclick=()=>{const e=new URL(window.location.href);e.searchParams.append(t.remoteDataParameterName,R.localPeerData),navigator.clipboard.writeText(e.toString())},s.onkeyup=()=>{s.value?r.removeAttribute("disabled"):r.setAttribute("disabled","true")},r.onclick=()=>o(void 0,void 0,void 0,(function*(){const e=s.value;a.style.display="none",d.style.display="block";try{yield R.joinConnection(e),y.style.display="block",v.value=R.localPeerData}catch(e){I.style.display="block"}d.style.display="none"})),_.onclick=()=>{navigator.clipboard.writeText(R.localPeerData)},m.onkeyup=()=>{m.value?g.removeAttribute("disabled"):g.setAttribute("disabled","true")},g.onclick=()=>{R.completeConnection(m.value)},f.onkeyup=()=>{f.value?b.removeAttribute("disabled"):b.setAttribute("disabled","true")},b.onclick=()=>{const e=f.value;A(`You: ${e}`),R.sendMessage(e),f.value="",b.setAttribute("disabled","true")},w.onclick=()=>{R.closeConnection()},S.onclick=()=>{P.innerHTML="",C.style.display="none",a.style.display="block",u.value="",m.value="",v.value="",s.value="",r.setAttribute("disabled","true"),g.setAttribute("disabled","true"),f.removeAttribute("disabled"),w.removeAttribute("disabled"),S.setAttribute("disabled","true"),B.innerHTML="",R.reset()},document.addEventListener("DOMContentLoaded",(function(){const e=new URL(document.location.toString()).searchParams.get(t.remoteDataParameterName);e&&(s.value=e,r.removeAttribute("disabled"),window.history.pushState({},"",window.location.origin+window.location.pathname))})),E.onclick=()=>{const e="block"===M.style.display;M.style.display=e?"none":"block",E.textContent=(e?"Show":"Hide")+" RTC activity"},D.onclick=S.onclick;const T=e=>{const t=document.createElement("div");t.innerText=e,B.prepend(t)},$=e=>()=>{N(),T(`${e} - connectionState: ${R.rtcConnection.connectionState} / signalingState: ${R.rtcConnection.signalingState} / iceConnectionState: ${R.rtcConnection.iceConnectionState} / iceGatheringState: ${R.rtcConnection.iceGatheringState}`)};R.on.connectionStateChange=$("Connection state change"),R.on.iceCandidate=e=>{T(`ICE candidate - protocol: ${e.protocol} / type: ${e.type} / address: ${e.address} / relatedAddress: ${e.relatedAddress}`)},R.rtcConnection.onicecandidateerror=e=>{T(`ICE candidate error - errorCode: ${e.errorCode} / errorText: ${e.errorText} / address: ${e.address}`)},R.rtcConnection.oniceconnectionstatechange=$("ICE Connection state change"),R.rtcConnection.onicegatheringstatechange=$("ICE Gathering state change"),R.rtcConnection.onnegotiationneeded=$("Negotiation needed"),R.rtcConnection.onsignalingstatechange=$("Signaling state change")}},t={};!function n(o){var i=t[o];if(void 0!==i)return i.exports;var a=t[o]={exports:{}};return e[o].call(a.exports,a,a.exports,n),a.exports}(784)})();